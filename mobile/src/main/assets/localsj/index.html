<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<link href="css/style.css" rel="stylesheet" type="text/css" />
<title>电费电量</title>
<script>
;(function(win,doc){
	function change(){
		document.documentElement.style.fontSize=document.documentElement.clientWidth/16+'px';
	}

	win.addEventListener('resize',change,false);
	win.addEventListener('DOMContentLoaded',change,false);

})(window,document);

</script>
</head>

<body>
<!--header-->
<div class="head">
  <div class="left_ico"><img src="images/img_03.png" id="fhBtn" /></div>
  <div class="mid">电量电费</div>
  <div class="right_ico"><img src="images/img_06.png" id="shareBtn" /></div>
</div>

<!--kehuxinxi-->
<div class="khxx">
  <div class="khxx_left"> <img src="images/user.png" /> </div>
  <div class="khxx_rt">
    <p class="khxx_tit name"></p>
    <p class="bihao">客户编号 <em></em></p>
    <p class="dizhi">用户地址 <em id=demo><em id=demo1></em><em id=demo2></em></em></p>
  </div>
</div>
<!--yibiaopan-->
<div class="ybp_con clearfix"> 
  <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
  <div class="con">
    <div id="main" style="height:280px;width:100%;margin:0 auto; padding-top:10px;border:0;"></div>
    <div id="box" class="box"> 
      <!-- <img src="1.png" alt=""><img src="2.png" alt=""><img src="3.png" alt=""> --> 
    </div>
  </div>
  <!--jieti-->
  <div class="jieti">
    <ol class="jieti_1">
      <li class="jt_1"><span></span>第一阶梯</li>
      <li class="jt_2"><span></span>第二阶梯</li>
      <li class="jt_3"><span></span>第三阶梯</li>
    </ol>
    <table cellpadding="0" cellspacing="0" border="0" class="jtTable">
      <tr>
        <td class="dl_month"><em></em>月电量</td>
        <td class="fl_du"><em></em>度</td>
        <td class="dl_compare"></td>
        <td class="dl_ds"><em></em></td>
      </tr>
      <tr>
        <td class="df_month"><em></em>月电费</td>
        <td class="df_yuan"><em></em>元</td>
        <td class="df_compare"></td>
        <td class="df_ds"></td>
      </tr>
    </table>
  </div>
</div>
<!--历史用电btn-->
<div class="jt_lsyd"> <a href="javascript:;" id="lsydBtn"> <span class="fl">历史用电</span> <span class="fr">详情&gt;&gt;</span> </a> </div>
<script src="js/echarts-all.js"></script> 
<script src="js/ybp.js"></script> 
<script src="js/common.js"></script> 
<script type="text/javascript">
 
var lsydBtn=document.querySelector("#lsydBtn");
var fhBtn=document.querySelector("#fhBtn");
var shareBtn=document.querySelector("#shareBtn");

var d = new Date();
var dqnf=d.getFullYear();
var dqyf=d.getMonth()+1;
//var dqyf=1;
var dqny="";
if(dqyf==1)
{
	dqny=dqnf-1+"12";
}
else
{
	dqny=dqnf+''+dqyf;
}

var yuandan=dqnf+'01';

//客户信息，电费电量基本信息，月信息，阶梯用能
var jsonkhxx="";
var jsondldf="";
var jsonjtyn="";



window.onload = function() {
   if(iosand()!='ios')
   {
	  //模块首页，h5向原生调用初始化方法fromJsFunction_init
	  //安卓json形式的字符串
	  var data='{"order":"getConsInfo"}';
	  window.sgcc.fromJsFunction_init(data);
   }

}
function showJsoninit(str){
	
	    //第一次获取客户信息
		jsonkhxx=eval('('+str+')');
	
		
		var data='{"requestCode":"GDT09003","versionCode":"1.1","data":{"consNo":'+jsonkhxx["data"]["consNo"]+',"endDate":'+dqny+'}}';
	  window.sgcc.fromJsFunction_transfer(data,'showJson');
		
}

function showJson(str){

	    //请求数据接口返回json,第二次获取电量电费月信息

		jsondldf=eval('('+str+')');
		
		var data='{"requestCode":"GDT08079","versionCode":"1.1","data":{"userMarkCode":'+jsonkhxx["data"]["consNo"]+'}}';
		
		
		
	  window.sgcc.fromJsFunction_transfer(data,'showJson1');
	
		//showShuju(json);
		
}


function showJson1(str){
	jsonjtyn=eval('('+str+')');
	showShuju(jsonjtyn);
}


if(iosand()=='ios')
{
	document.addEventListener('WebViewJavascriptBridgeReady', onBridgeReady, false)
	function onBridgeReady(event) {
        var bridge = event.bridge;
        var uniqueId = 1;
        var data = null;
        bridge.send(data, function (responseData) {
        });
		bridge.init(function (message, responseCallback) { 	 
		});
		
		
		//第一次请求用户编号
    bridge.callHandler('fromJsFunction_init', 
                 {"order":"getConsInfo"}, 
                 function callback(response) {
                   
				   jsonkhxx=eval('('+response+')');
		//{"data":{"consName":"张三","addr":"北京丰台时代财富","orgNo":"3340201","consNo":"1510122432"},"requestFunction":"getConsInfo"}
		            var data=jsonkhxx["data"]["consNo"];
                 
				    showhtJson(data) 
	    
				}
        )
		
  function showhtJson(str){
			
		//第二次请求后台数据,查询电量电费信息
		
    bridge.callHandler('fromJsFunction_transfer', 
                 {'requestCode':'GDT09003','versionCode':'1.1','data':{'consNo':parseInt(str),'endDate':parseInt(dqny)}}, 
                 function callback(response) {
                   
				   jsondldf=eval('('+response+')');
		          
		          showhtJson1(str);  
	    
			}
        )
	}	
 function showhtJson1(str){
			
		//第二次请求后台数据,阶梯用能查询
		
    bridge.callHandler('fromJsFunction_transfer', 
                 {'requestCode':'GDT08079','versionCode':'1.1','data':{'userMarkCode':parseInt(str)}}, 
                 function callback(response) {
                   
				   jsonjtyn=eval('('+response+')');
		          
		          showShuju(jsonjtyn);  
	    
			}
        )	
		
		
			
			
			
	}
		
		
		
		
		
		
		var anyBtn;
	    lsydBtn.onclick=function(){
			
		   anyBtn1=document.querySelector('.bihao em').innerHTML;
		    anyBtn={"type":3,"url":"lsyd.html","param":{"requestCode":"GDT09003","versionCode":"1.1","data":{"consNo":parseInt(anyBtn1),'lastDate':parseInt(yuandan),'endDate':parseInt(dqny)}}}
			bridge.callHandler('fromJsFunction_jump', 
                 anyBtn,
                 function callback(response) {
              
	             })	

		}
		
		fhBtn.onclick=function(){
		 
		   bridge.callHandler('fromJsFunction_back',
                 function callback(response) {
	             })
		  
		}
		
		shareBtn.onclick=function(){
		   
		   shareBtn={"title":"下载“掌上电力”，参与有奖活动吧","content":" 掌上电力开展限时优惠活动，数量有限，先到先得，马上行动哟！"};
		   
		    bridge.callHandler('fromJsFunction_share',
			        shareBtn,
                 function callback(response) {
	             }
            )
		}
		
		
	}
	

	
}else
{
	var anyBtn;
	 lsydBtn.onclick=function(){
		 //历史用电点击事件，调用原生跳转接口fromJsFunction_jump
		 anyBtn1=document.querySelector('.bihao em').innerHTML;
		 anyBtn='{"type":3,"url":"lsyd.html","param":{"requestCode":"GDT09003","versionCode":"1.1","data":{"consNo":'+anyBtn1+',"lastDate":'+yuandan+',"endDate":'+dqny+'}}}';
		
		window.sgcc.fromJsFunction_jump(anyBtn);		
	};
	fhBtn.onclick=function(){
		//返回按钮点击事件，调用原生返回接口fromJsFunction_back
		window.sgcc.fromJsFunction_back();		
	};
	shareBtn.onclick=function(){
		//分享按钮点击事件，调用原生分享接口fromJsFunction_share
		shareBtn='{"title":"下载“掌上电力”，参与有奖活动吧","content":" 掌上电力开展限时优惠活动，数量有限，先到先得，马上行动哟！"}';
		window.sgcc.fromJsFunction_share(shareBtn);		
	};
} 


function showShuju(json){
//alert(json["data"]["requestCode"]);
//客户信息{"data":{"consName":"张三","addr":"北京丰台时代财富","orgNo":"3340201","consNo":"1510122432"},"requestFunction":"getConsInfo"}
//alert(jsonkhxx["data"]["consNo"]+'-1');
//alert(jsondldf["data"]["requestCode"]+'-2');


    var demo=document.getElementById("demo");
	var demo1=document.getElementById("demo1");
	var demo2=document.getElementById("demo2");

    var oName=document.querySelector('.name');
	var oBh=document.querySelector('.bihao em');
	var oAdres=document.querySelector('.dizhi #demo1');
	var dl_month=document.querySelector('.dl_month em');
	var fl_du=document.querySelector('.fl_du em');
	var df_month=document.querySelector('.df_month em');
	var df_yuan=document.querySelector('.df_yuan em');
	var dl_compare=document.querySelector('.dl_compare');
	var dl_ds=document.querySelector('.dl_ds');
	var df_compare=document.querySelector('.df_compare');
	var df_ds=document.querySelector('.df_ds');
	
	
	//var data=json['Quantity']["quantity"];
	var data2=jsondldf['data']["quantityList"]["quantity"];
	
	var data={
			  "consNo":"0241412482",
			  "consName":"陈伟",
			  "quantityLevel":"1",
			  "levelPercent":"100%",
			  "userPercent":"100%",
			  "year":"2016",
			  "yearQuantity":"2630",
			  "yearElectricity":"1578.00",
			  "lastMonth":"07",
			  "monthQuantity":"253",
			  "monthElectricity":"151.8",
			  "orgName":"本地区"
			  };


	
	
	oName.innerHTML='*'+jsonkhxx['data']['consName'].substring(1);
	oBh.innerHTML=jsonkhxx['data']["consNo"];
	oAdres.innerHTML=jsonkhxx['data']["addr"].substring(0,2)+'******'+jsonkhxx['data']["addr"].substring(jsonkhxx['data']["addr"].length-2)+'。';
	
	dl_month.innerHTML=data["lastMonth"];
	fl_du.innerHTML=data["monthQuantity"];
	df_month.innerHTML=data["lastMonth"];
	df_yuan.innerHTML=data["monthElectricity"];
	
	
	//与上个月的值相比较
	//判断电量
	var Month=parseInt(data["lastMonth"]);
	var last=(toDou(Month-1)).toString();



	var lastDl=null,
		lastDf=null;
	//alert((data2[1]["month"].toString()).substring(4))
	for(var i=0; i<data2.length; i++){

	if((data2[i]["month"].toString()).substring(4)==last){
			lastDl=data2[i]["monthQuantity"];
			lastDf=data2[i]["monthElectricity"];
		}
	}

	dl_compare.innerHTML=comparteToMonth(data["monthQuantity"],lastDl);
	dl_ds.innerHTML=Math.abs((parseFloat(data["monthQuantity"])-parseFloat(lastDl)).toFixed(2));


	//判断电费
	df_compare.innerHTML=comparteToMonth(data["monthElectricity"],lastDf);
	df_ds.innerHTML=Math.abs((parseFloat(data["monthElectricity"])-parseFloat(lastDf)).toFixed(2));
	//月份前补0
	function toDou(n){
		return n<10 ? "0"+n : ""+n;
	}
	//比较函数n:本月m:上个月
	function comparteToMonth(n,m){
		if(n-m>0){
			return "比上月增加";
		}else{
			return "比上月减少"
		}
	};
	
	
	//仪表盘传入年度电量
	var zdl=data['yearQuantity'];
	var lev1Kwh=Number(jsonjtyn["data"]["ladderInfo"]['lev1Kwh']);
	var lev2Kwh=Number(jsonjtyn["data"]["ladderInfo"]['lev2Kwh']);
	var zdlbl=0;
	if(zdl>0 && zdl<lev1Kwh)
	{
		zdlbl=zdl/lev1Kwh*33;
	}
	else if(zdl==lev1Kwh)
	{
		zdlbl=33;
	}
	else if(zdl>lev1Kwh && zdl<lev2Kwh)
	{
		zdlbl=(zdl-lev1Kwh)/(lev2Kwh-lev1Kwh)*33+33;
	}
	else if(zdl==lev2Kwh)
	{
		zdlbl=66;
	}
	else if(zdl>lev2Kwh && zdl<19200)
	{
		zdlbl=(zdl-lev2Kwh)/(19200-lev2Kwh)*33+66;
	}
	else if(zdl<0)
	{
		zdlbl=0;
	}
	else if(zdl>=19200)
	{
		zdlbl=100;
	}



  
//地址运动
  var speed=50
  demo2.innerHTML=demo1.innerHTML
  function Marquee(){
  if(demo2.offsetWidth-demo.scrollLeft<=0)
  demo.scrollLeft-=demo1.offsetWidth
  else{
  demo.scrollLeft++
  }
  }
  var MyMar=setInterval(Marquee,speed)
  demo.onmouseover=function() {clearInterval(MyMar)}
  demo.onmouseout=function() {MyMar=setInterval(Marquee,speed)}
 
  
  

	
  ybp(data['yearQuantity'],zdlbl,lev1Kwh,lev2Kwh)	
		
}




 </script>
</body>
</html>
